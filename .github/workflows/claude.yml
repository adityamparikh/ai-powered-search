name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Allow Claude to make code changes
      pull-requests: write  # Allow Claude to update PRs
      issues: write  # Allow Claude to comment on issues
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # This is an optional setting that allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read

          # Custom context for Spring Boot application
          prompt: |
            You are working on a Spring Boot 3.5.7 application with Java 21.
            This is an AI-powered search application using Apache Solr for search,
            Anthropic Claude for AI, and OpenAI for embeddings.
            The project uses Gradle for build management.
            When making changes, ensure Spring Boot best practices and
            maintain the package-by-feature architecture.

          # Claude args configured for Java/Spring Boot development
          claude_args: |
            --allowed-tools Bash(./gradlew:*) \
            --allowed-tools Bash(git:*) \
            --allowed-tools Bash(gh:*) \
            --allowed-tools Edit \
            --allowed-tools Read \
            --allowed-tools Write \
            --allowed-tools Glob \
            --allowed-tools Grep

